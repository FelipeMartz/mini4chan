<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Nimbus â€” red social ligera</title>
<style>
  :root{
    --bg:#0f1220; --card:#171a2b; --muted:#8b90a6; --text:#e9ecf4; --accent:#6c92ff;
    --gaming:#4f7cff; --music:#ff6ca8; --ideas:#6dffa7; --random:#ffd36c;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:linear-gradient(180deg,#0b0e1a,#12162a);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
  .app{max-width:860px;margin:auto;padding:16px}
  .topbar{
    position:sticky;top:0;z-index:10;background:rgba(15,18,32,.8);backdrop-filter:blur(8px);
    border-bottom:1px solid rgba(255,255,255,.06);display:flex;align-items:center;gap:12px;padding:10px 12px;border-radius:0 0 12px 12px;
  }
  .brand{font-weight:800;letter-spacing:.3px}
  .pill{padding:6px 10px;border:1px solid rgba(255,255,255,.1);border-radius:999px;color:var(--muted);display:flex;align-items:center;gap:6px}
  .btn{cursor:pointer;border:0;border-radius:12px;padding:10px 14px;background:var(--accent);color:#0a0c18;font-weight:700}
  .btn.ghost{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,.14)}
  .grid{display:grid;grid-template-columns:1fr 320px;gap:16px}
  @media (max-width:920px){ .grid{grid-template-columns:1fr} }
  .card{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
  .composer{padding:14px}
  .composer header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
  .composer .who{color:var(--muted);font-size:.95rem}
  textarea,input,select{width:100%;background:#0e1120;border:1px solid rgba(255,255,255,.08);color:var(--text);border-radius:12px;padding:12px;font-size:15px;outline:none}
  textarea{resize:vertical;min-height:72px}
  .row{display:flex;gap:10px;align-items:center;margin-top:10px}
  .row .btn{padding:10px 16px}
  .sidebar{display:flex;flex-direction:column;gap:12px;height:max-content;position:sticky;top:68px}
  .panel{padding:12px}
  .muted{color:var(--muted);font-size:.95rem}
  .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .chip{padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);cursor:pointer}
  .chip.active{border-color:var(--accent);box-shadow:0 0 0 2px rgba(108,146,255,.2) inset}
  .stream{display:flex;flex-direction:column;gap:12px;margin-top:16px}
  .post{padding:12px;display:grid;grid-template-columns:auto 1fr;gap:10px}
  .tag{width:8px;border-radius:6px}
  .tag.gaming{background:var(--gaming)} .tag.music{background:var(--music)}
  .tag.ideas{background:var(--ideas)} .tag.random{background:var(--random)}
  .meta{display:flex;gap:8px;align-items:center;color:var(--muted);font-size:.9rem}
  .meta .dot{width:4px;height:4px;background:rgba(255,255,255,.35);border-radius:50%}
  .content{white-space:pre-wrap;line-height:1.35}
  .actions{display:flex;gap:10px;margin-top:8px}
  .react{display:flex;align-items:center;gap:6px;padding:8px 10px;border:1px solid rgba(255,255,255,.12);border-radius:12px;cursor:pointer;background:#0e1120}
  .react:hover{border-color:rgba(255,255,255,.2)}
  .danger{color:#ff7b7b}
  .notice{padding:10px;border:1px dashed rgba(255,255,255,.2);border-radius:12px;margin-top:10px}
  .small{font-size:.85rem}
  .footer{margin:28px auto 12px;color:var(--muted);text-align:center}
</style>
<!-- Firebase modular SDKs -->
<script type="module">
  /********************* Firebase setup *********************/
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import {
    getFirestore, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot,
    updateDoc, doc, increment, deleteDoc
  } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

  // ðŸ‘‰ Reemplaza aquÃ­ si cambias de proyecto
  const firebaseConfig = {
    apiKey: "AIzaSyAuJNMD4d0a2uehA4UCEx7WNRlkjzWG8X8",
    authDomain: "mini4chan-50c4d.firebaseapp.com",
    projectId: "mini4chan-50c4d",
    storageBucket: "mini4chan-50c4d.firebasestorage.app",
    messagingSenderId: "476495367772",
    appId: "1:476495367772:web:3ce2ab7266bfd047eba099",
    measurementId: "G-VSC6XWFGE7"
  };
  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  /********************* Helpers (cookies, time, ui) *********************/
  const $ = (sel)=>document.querySelector(sel);
  const el = (tag,cls)=>{ const x=document.createElement(tag); if(cls)x.className=cls; return x; };
  function setCookie(name,val,days=365){
    const d=new Date(); d.setTime(d.getTime()+days*24*60*60*1000);
    document.cookie=`${name}=${encodeURIComponent(val)};path=/;expires=${d.toUTCString()}`;
  }
  function getCookie(name){
    return document.cookie.split(';').map(c=>c.trim()).reduce((acc,c)=>{
      if(c.startsWith(name+'=')) acc=decodeURIComponent(c.slice(name.length+1)); return acc;
    },'');
  }
  const categories = [
    {id:'gaming', label:'Gaming', color:'var(--gaming)'},
    {id:'music',  label:'MÃºsica', color:'var(--music)'},
    {id:'ideas',  label:'Ideas',  color:'var(--ideas)'},
    {id:'random', label:'Random', color:'var(--random)'},
  ];
  function timeAgo(ts){
    if(!ts) return 'â€¦';
    const ms = Date.now() - ts.toMillis();
    const s = Math.max(1, Math.floor(ms/1000));
    if(s<60) return s+'s';
    const m = Math.floor(s/60); if(m<60) return m+'m';
    const h = Math.floor(m/60); if(h<24) return h+'h';
    const d = Math.floor(h/24); return d+'d';
  }

  /********************* State *********************/
  let currentUser = getCookie('nimbus_user') || '';
  let selectedCategory = 'gaming';          // composer
  let filterCategory   = 'all';             // stream filter
  const EXP_HOURS = 48;                     // caducidad
  const EXP_MS    = EXP_HOURS*60*60*1000;

  /********************* DOM bind *********************/
  const nameBadge   = $('#name-badge');
  const changeName  = $('#change-name');
  const namePrompt  = $('#name-prompt');
  const nameInput   = $('#name-input');
  const nameSave    = $('#name-save');

  const catSelect   = $('#cat-select');
  const postText    = $('#post-text');
  const postSend    = $('#post-send');
  const stream      = $('#stream');
  const filterWrap  = $('#filter-chips');

  // init name
  function ensureName(){
    if(currentUser){
      nameBadge.textContent = currentUser;
      namePrompt.style.display='none';
    } else {
      namePrompt.style.display='block';
    }
  }
  ensureName();

  changeName.addEventListener('click', ()=>{
    namePrompt.style.display='block';
    nameInput.value=currentUser;
    nameInput.focus();
  });
  nameSave.addEventListener('click', ()=>{
    const v = nameInput.value.trim().slice(0,30);
    if(!v) return;
    currentUser = v;
    setCookie('nimbus_user', currentUser, 365);
    nameBadge.textContent = currentUser;
    namePrompt.style.display='none';
  });

  // composer category select
  categories.forEach(c=>{
    const opt = el('option'); opt.value=c.id; opt.textContent=c.label;
    catSelect.appendChild(opt);
  });
  catSelect.value = selectedCategory;
  catSelect.addEventListener('change', e=> selectedCategory = e.target.value);

  // filter chips
  function renderFilterChips(){
    filterWrap.innerHTML='';
    const all = el('div','chip'+(filterCategory==='all'?' active':'')); all.textContent='Todos'; all.onclick=()=>{filterCategory='all'; renderFilterChips();};
    filterWrap.appendChild(all);
    categories.forEach(c=>{
      const chip = el('div','chip'+(filterCategory===c.id?' active':'')); chip.textContent=c.label;
      chip.onclick=()=>{filterCategory=c.id; renderFilterChips();};
      filterWrap.appendChild(chip);
    });
  }
  renderFilterChips();

  // send post
  postSend.addEventListener('click', async ()=>{
    const text = postText.value.trim();
    if(!currentUser){ namePrompt.style.display='block'; nameInput.focus(); return; }
    if(!text) return;
    await addDoc(collection(db,'posts'),{
      text, author: currentUser, category: selectedCategory,
      reactions:{fire:0, idea:0, lol:0},
      timestamp: serverTimestamp()
    });
    postText.value='';
  });

  /********************* Stream (real-time) *********************/
  const q = query(collection(db,'posts'), orderBy('timestamp','desc'));
  onSnapshot(q, (snap)=>{
    stream.innerHTML='';
    snap.forEach(docSnap=>{
      const data = docSnap.data();
      // caducidad (ocultar y limpiar)
      const ts = data.timestamp;
      const expired = ts && (Date.now() - ts.toMillis() > EXP_MS);
      if(expired){
        // intento de limpieza (si reglas lo permiten)
        deleteDoc(doc(db,'posts',docSnap.id)).catch(()=>{});
        return;
      }
      // filtro por categorÃ­a
      if(filterCategory!=='all' && data.category!==filterCategory) return;

      const card = el('div','card post');
      const tag = el('div','tag '+data.category); card.appendChild(tag);
      const body = el('div'); card.appendChild(body);

      // meta
      const meta = el('div','meta');
      const catObj = categories.find(c=>c.id===data.category);
      const catLabel = catObj?catObj.label:data.category;
      meta.innerHTML = `<strong>${escapeHtml(data.author||'AnÃ³nimo')}</strong>
                        <span class="dot"></span>
                        <span>${catLabel}</span>
                        <span class="dot"></span>
                        <span class="small">${ts?timeAgo(ts):'â€¦'}</span>`;
      body.appendChild(meta);

      // content
      const content = el('div','content'); content.textContent = data.text || '';
      body.appendChild(content);

      // actions (reacciones)
      const actions = el('div','actions');
      const rFire = makeReact('ðŸ”¥', data.reactions?.fire||0, ()=> bump(docSnap.id,'reactions.fire'));
      const rIdea = makeReact('ðŸ’¡', data.reactions?.idea||0, ()=> bump(docSnap.id,'reactions.idea'));
      const rLol  = makeReact('ðŸ˜‚', data.reactions?.lol ||0, ()=> bump(docSnap.id,'reactions.lol'));
      actions.append(rFire, rIdea, rLol);

      // autor puede eliminar su post (mismo nombre)
      if((data.author||'') === currentUser){
        const del = el('div','react danger'); del.textContent='Eliminar';
        del.onclick=()=> deleteDoc(doc(db,'posts',docSnap.id)).catch(console.warn);
        actions.appendChild(del);
      }
      body.appendChild(actions);

      stream.appendChild(card);
    });
  });

  async function bump(id, path){
    // incrementa contador de reacciÃ³n
    await updateDoc(doc(db,'posts',id), { [path]: increment(1) });
  }

  function makeReact(emoji,count,onClick){
    const r = el('div','react'); r.innerHTML=`<span>${emoji}</span><span>${count}</span>`; r.onclick=onClick; return r;
  }

  // naive HTML escape for author only (content se mete como textContent arriba)
  function escapeHtml(str){ return String(str).replace(/[&<>"']/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[s])); }
</script>
</head>
<body>
  <div class="topbar">
    <div class="brand">Nimbus</div>
    <div class="pill">Usuario: <strong id="name-badge">â€”</strong></div>
    <button class="btn ghost" id="change-name">Cambiar nombre</button>
  </div>

  <div class="app grid">
    <main>
      <section class="card composer">
        <header>
          <div class="who">Publica como <strong id="name-badge-dup"></strong></div>
        </header>
        <div class="row">
          <select id="cat-select" aria-label="CategorÃ­a"></select>
        </div>
        <div class="row">
          <textarea id="post-text" placeholder="Â¿QuÃ© querÃ©s compartir hoy?"></textarea>
        </div>
        <div class="row">
          <button class="btn" id="post-send">Publicar</button>
        </div>
        <div class="notice small">Los posts duran <strong>48 horas</strong> y luego desaparecen.</div>
      </section>

      <section class="stream" id="stream" aria-live="polite"></section>
    </main>

    <aside class="sidebar">
      <div class="card panel">
        <div class="muted">Filtrar por tema</div>
        <div class="chips" id="filter-chips"></div>
      </div>
      <div class="card panel">
        <div class="muted">Tu identidad</div>
        <div class="notice small">
          Tu nombre se guarda en una cookie local (no es un login real).
        </div>
        <div id="name-prompt" style="display:none; margin-top:8px;">
          <input id="name-input" type="text" maxlength="30" placeholder="Tu nombre" />
          <div class="row"><button class="btn" id="name-save">Guardar</button></div>
        </div>
      </div>
    </aside>
  </div>

  <div class="footer small">Hecho con ðŸ’™ por Felipe â€” Nimbus beta</div>

<script>
  // Mantener en sincronÃ­a el nombre en dos lugares del header
  (function syncBadges(){
    const a = document.getElementById('name-badge');
    const b = document.getElementById('name-badge-dup');
    const obs = new MutationObserver(()=>{ b.textContent = a.textContent; });
    b.textContent = a.textContent;
    obs.observe(a,{childList:true});
  })();
</script>
</body>
</html>


